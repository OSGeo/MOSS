$Include:'dbchan.inc'
$Include:'dnames.inc'
        COMMON /WORK/  IBUFF(128),MAP(25),ICOM(10),JCOM(10)
        COMMON /FLS/   IUNIT,IFILE(5)
        COMMON /IO/    NPRNT,IOIN
        COMMON /TYPE/  IDATYP(40),NACTS
        COMMON /WHMAP/ ISTRCT(300),NSTRCT
$Include:'strng.inc'
C
        DIMENSION IHEAD(256),IDESC(30),mapname(25)
        DIMENSION IARR(20),LABEL(16),isub(15),idesc1(60)
        DIMENSION IBUFF1(128),IBUFF2(128),mbr(8)
        DIMENSION IXX(2),IYY(2),IIXX(2),IIYY(2)
        EQUIVALENCE (BXMIN,IXX(1)),(BXMAX,IIXX(1))
        EQUIVALENCE (BYMIN,IYY(1)),(BYMAX,IIYY(1))
        EQUIVALENCE ( XMIN,IBUFF(15)),(XMAX,IBUFF(17))
        EQUIVALENCE ( YMIN,IBUFF(19)),(YMAX,IBUFF(21))
C
C ******************************************************************
C
C           P R O G R A M     M E R G E
C
C FUNCTION:   THIS ROUTINE IS THE LOGICAL DRIVER FOR THE MERGE
C             COMMAND. ITS FUNCTION IS TO ALLOW A USER TO MERGE
C             AN ACTIVE DATA SET AS PART OF THEIR WORKFILE.
C             THIS COMMAND DOES NOT APPLY TO CELL FILES.
C ******************************************************************
C
C
C  GET COMMON
C
        CALL initl(ier)
        if(ier.ne.0)stop
C
C SET PROMPT SWITCH AND OTHER PARAMETERS
C
      IPROMT=0
      ITEMC=0
      LINES=0
      ICHAN1 = 10
      ICHAN2 = 20
      ICHAN3 = 2
      ICTSB = 51
      ICTSUB = 52
 1000 FORMAT(' ENTER ACTIVE MAP I.Ds TO MERGE'\)
C

C
C  SET UPPER LIMITS FOR MAP WINDOW BOUNDARY
C
      BXMIN=9999999.
      BYMIN=BXMIN
      BXMAX=-BXMIN
      BYMAX=BXMAX
C
C Open temp file
C
      map(1)=2hX
      call openf(ictsub,map,3,256,2,ier)

C  GET ACTIVE DATA SETS TO MERGE
C
      CALL DAGET(ICARD,K,IARR,20,MACTS)
      IF(MACTS.NE.0) GO TO 10
C
C  PROMPT FOR ACTIVE DATA SETS TO MERGE
C
      IPROMT=1
  5   CONTINUE
      WRITE(NPRNT,1000)
      CALL READIN(ICARD,lenicd,K,istop)
      CALL DAGET(ICARD,K,IARR,20,MACTS)
      LINES=LINES+3
      IF(MACTS.EQ.0) GO TO 5
      IF(IPROMT.EQ.1) GO TO 15
C
C  GET NAME OF NEW WORKFILE MAP NAME
C
  10  CONTINUE
      CALL DECIP(ICARD,LABEL,K)
      IF(LABEL(1).NE.0) GO TO 20
C
C PROMPT FOR MAP NAME
C
  15  CONTINUE
      CALL WHTCAL(LABEL,ier)
C
C  NOW CHECK ALL PARAMETERS FOR VALIDITY.
C
C  FIRST, DOES THIS MAP FILE NAME ALREADY EXIST ?
C
  20  CONTINUE
      CALL MCHEK(LABEL,IFIL,NENTS,ITYPE,IER)
      IF(IFIL.EQ.0) GO TO 21
      WRITE(NPRNT,90104)
90104 FORMAT(' THIS MAP NAME ALREADY EXISTS...PLEASE USE ANOTHER NAME')
      LINES=LINES+2
      GO TO 120
C
C  WE ARE O.K..  PACK MAP NAME
C
 21    CALL CLEAR(JCOM(1),10)
       CALL PACKC(LABEL,JCOM,10)
C
C  JCOM NOW CONTAINS NEW MAP NAME.  CREATE FILE
C
C  AND OPEN A DATA CHANNEL TO IT
C
        CALL OPENF(ICHAN2,JCOM,0,256,2,IER)
        IF(IER.NE.0) GO TO 112
C
C  CHECK TO SEE IF TRYING TO MERGE CELL FILES
C
        index=iarr(1)
        idtype=idatyp((index/7)+1)
        DO 23 I=1,MACTS
        INDEX=IARR(I)
        IF(IDATYP((INDEX/7)+1).EQ.6) GO TO 101
        if(idatyp((index/7)+1).ne.idtype)go to 117
  23    CONTINUE
C
C  GET NEW MAP DESCRIPTOR
C
        DO 25 I=1,30
          IDESC(I) = 32
  25    CONTINUE
        WRITE(NPRNT,1004)
 1004   FORMAT(' PLEASE ENTER 60 CHARACTER OR LESS MAP DESCRIPTION')
        call readin(idesc1,60,icardp,istop)
        call packc(idesc1,idesc,60)
C
C  ALL INPUT O.K.  NOW GET TOTAL NUMBER OF SUBJECTS IN
C  MERGED MAP  AND BUILD MERGED MAP HEADER
C
      CALL BLDSUB (NTSUB,IARR,MACTS,ICTSUB,IER)
C
C  sort subject file into a fast file
C
        map(1)=2hc
        call openf(ictsb,map,3,256,2,ier)
        call srttmp(ictsub,ictsb,ntsub,nnsub,ier)
      call clear(ihead,256)
      ihead(64)=1
      ihead(65)=nnsub
      ihead(66)=0
      ihead(67)=nnsub

C
C  PUT IN NEW DESCRIPTION
C
C  OPEN POINTER FILE
C
        CALL OPENF(icdcfa,idesfa,1,512,2,IER)
        IF(IER.NE.0) GO TO 116
C
C
       DO 28 I=1,30
         IHEAD(I+19)=IDESC(I)
  28   CONTINUE
C
C  WRITE OUT HEADER TO NEW MAP
C
        CALL WRBLK(ICHAN2,1,IHEAD,1,IER)
C
C  CALCULATE ADDRESS OF LOCATION AT WHICH TO WRITE FIRST ITEM
C
        NREC=IHEAD(64)+IHEAD(65)+2
C
C  DO DUMMY WRITE TO PREVENT EOF ON SUBJECT TABLE BUILD
C
        CALL WRBLK(ICHAN2,NREC,IHEAD,1,IER)

C
C  NOW MERGE DATA
C
C
C  IHEAD CONTAINS THE HEADER, IBUFF THE NEW RECORD, IBUFF1
C  IS USED FOR WORK SPACE AND IBUFF2 IS USED FOR WORK SPACE
C
        KOUNT=0
        DO 40 JK=1,MACTS
        INDEX=IARR(JK)
        CALL APGET(INDEX,ISTART,ISTOP,NTOTAL)
        WRITE(NPRNT,1008) NTOTAL
 1008   FORMAT(' NUMBER OF DATA ITEMS TO BE SAVED =',I5)
        KOUNT=KOUNT+NTOTAL
        LINES=LINES+2
C
C  GET MAP NAME
C
       CALL CLEAR(ICOM(1),10)
       CALL GTMAP(ICOM,INDEX)
       call clear(mapname,25)
C
C  OPEN CHANNEL TO INPUT MAP
C
        call adddir(icom,mapname)
        CALL OPENF(ICHAN1,mapname,1,256,2,IER)
       IF(IER.NE.0) GO TO 114
C
C  ENTER TRANSFER LOOP
C
      DO 30 I=ISTART,ISTOP
      ITEMC=ITEMC+1
C
C  GET POINTER
C
      CALL GETFAST(I,MBR,INDEX,isubj,iattr,ixtra,IER)
      IF(IER.NE.0) GO TO 30
C
C  READ ITEM HEADER
C
        CALL RDBLK(ICHAN1,INDEX,IBUFF,1,IER)
C
C  GET SUBJECT POINTER FOR THIS ITEM
C
        IPOINT=isubj
C
C  GET SUBJECT FOR THIS ITEM
C
C
        CALL GETSUB(ICHAN1,IPOINT,IBUFF1,isub,ITS)
C
C  PUT SUBJECT IN NEW MAP'S SUBJECT TABLE
C
      CALL PUTSUB(IBUFF,NREC,isub,NNSUB,ICHAN2,ICTsb,IER)
C
C  GET NUMBER OF COORDINATE RECORDS
C
        NRS=IBUFF(2)
C
C  STORE NEW ITREM NUMBER
C
      IBUFF(5)=ITEMC
C
C  CALCULATE LINK TO NEXT RECORD
C
        IBUFF(1)=NREC+NRS
C
C  WRITE OUT ITEM HEADER
C
        CALL WRBLK(ICHAN2,NREC,IBUFF,1,IER)
        BXMIN=AMIN1(BXMIN,XMIN)
        BYMIN=AMIN1(BYMIN,YMIN)
        BXMAX=AMAX1(BXMAX,XMAX)
        BYMAX=AMAX1(BYMAX,YMAX)
C
C  INCREMENT NREC
C
        NREC=NREC+1
C
C  TRNASFER COORDINATE DATA
C
        NRS=NRS-1
        DO 22 IC=1,NRS
        INDEX=INDEX+1
        CALL RDBLK(ICHAN1,INDEX,IBUFF,1,IER)
        CALL WRBLK(ICHAN2,NREC,IBUFF,1,IER)
        NREC=NREC+1
  22    CONTINUE
  30    CONTINUE
        CLOSE(ICHAN1,iostat=IER)
  40    CONTINUE
C
C  UPDATE HEADRER WITH TRUE COUNTS
C
       IHEAD(1) = NREC-1
       ihead(62)=idtype
       IHEAD(63) = kount
       IHEAD(68)=IXX(1)
       IHEAD(69)=IXX(2)
       IHEAD(70)=IIXX(1)
       IHEAD(71)=IIXX(2)
       IHEAD(72)=IYY(1)
       IHEAD(73)=IYY(2)
       IHEAD(74)=IIYY(1)
       IHEAD(75)=IIYY(2)
       CALL WRBLK(ICHAN2,1,IHEAD,1,IER)
       CALL WRBLK(ICHAN2,2,IHEAD(129),1,IER)
C
C     UPDATE DIRECTORY
C
       CLOSE(ICHAN2,iostat=IER)
C       CALL OPENF(ICHAN3,iwork,1,512,2,IER)
C       IF(IER.NE.0) GO TO 110
       CALL TUPDIR(ITP1,ITP2,ITP3,LABEL,IHEAD,iwork,icwork,IER)
       CLOSE(ICHAN3,iostat=IER)
C
C  ALL DONE
C
 100    CONTINUE
        WRITE(NPRNT,1080) KOUNT,(JCOM(I),I=1,5)
 1080   FORMAT(' MERGE COMPLETE ',I5,' ITEMS IN NEW MAP ',5A2)
        LINES=LINES+1
 120    go to 9898
C
C  ERROR PROCESSING
C
 101  write(*,*)' This command does not work w/ raster data'
      GO TO 120
 110  write(*,*)' Could not open <project.DT>'
      GO TO 120
 112  write(*,*)' Error on accessing input map'
      GO TO 120
 114  write(*,*)' Error on accessing input map'
      GO TO 120
 116  write(*,*)' Could not open <(project name).FA>'
      go to 120
 117  write(*,*)' Cannot MERGE maps of different types.'
9898  continue
      END
