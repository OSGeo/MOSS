C************************************************************************
C
C              R O U T I N E    S T A T S
C
C  FUNCTION - LOGICAL DRIVER FOR THE STATISTICS COMMAND
C
C  REQUIRED SUBROUTINES - MCOMP, DAGET, Qreadin, Qdecip, Qcalerr, Qopenf
C                         SHISTO, SDESC, SDESCR, SCROST, COMINIT,
C                         COMARG, INITT
C******************************************************************************
C
      COMMON /STRNG/ ICARD(80),ICARDP,LENICD
      COMMON /TYPE/  IDATYP(40),NACTS
      COMMON /IO/    NPRNT, IOIN
      COMMON /FLS/   IUNIT,IFILE(5)
      COMMON /WHMAP/ ISTRCT(300),NSTRCT
      COMMON /DBCHAN/ ICMAST,ICWORK,ICDCFA,ICDCDT,IDESFA(10),IDESDT(10)
      common /dsbuf/mlen,idata(8192)
      INTEGER*2 ICOM(10),MAP(25),MAPX(10)
      LOGICAL MCOMP
C
      mlen=8193
C    READ IN THE COMMON BLOCKS
C
      call initl(IER)
      IF(IER .NE. 0) GO TO 8000
C
C.....CHECK COMMAND LINE FOR A SWITCH
C
C
      mapX(1)=2HLX
      mapX(2)=2h
      call openf(70,mapX,0,0,1,ier)
C
      CALL INITT ( 1, IUNIT, IFILE )
c
C  SET SOME VARIABLES AND CLEAR SOME ARRAYS
C
      IPRMT=0
      LINES=1
C
C  GET ACTIVE DATA SET(S) TO USE
C
      CALL DAGET(ICARD,ICARDP,MAP,25,MACTS)
      IF(MACTS.NE.0) GO TO 10
C
C  PROMPT FOR ACTIVE DATA SET
C
      IPRMT=1
      WRITE(NPRNT,1000)
 1000 FORMAT(' ENTER ACTIVE MAP ID(S) FOR STATISTICS'\)
      call readin(ICARD,80,ICARDP,LENICD)
      CALL DAGET(ICARD,ICARDP,MAP,25,MACTS)
      LINES=LINES+3
      GO TO 15
C
C  GET STATISTICS TYPE
C
  10  CONTINUE
      call decip(ICARD,ICOM,ICARDP)
      IF(ICOM(1).NE.0) GO TO 20
C
C  PROMPT FOR STAT TYPE
C
  15  CONTINUE
      WRITE(NPRNT,1001)
 1001 FORMAT(' ENTER STATISTICS TYPE (DESCRIBE,HISTOGRAM)'\)
      call readin(ICARD,80,ICARDP,LENICD)
      call decip(ICARD,ICOM,ICARDP)
      LINES=LINES+3
C
C  BASIC INPUT COMPLETED.  CHECK IT.
C
  20  CONTINUE
      NSTYP=0
      IF((MCOMP(ICOM,'D',1,IER)).or.
     +   (MCOMP(ICOM,'DE',2,IER)).or.
     +   (MCOMP(ICOM,'DES',3,IER)).or.
     +   (MCOMP(ICOM,'DESC',4,IER))) NSTYP=1
      IF((MCOMP(ICOM,'C',1,IER)).or.
     +   (MCOMP(ICOM,'CR',2,IER)).or.
     +   (MCOMP(ICOM,'CRO',3,IER)).or.
     +   (MCOMP(ICOM,'CROS',4,IER)).or.
     +   (MCOMP(ICOM,'CROSS',5,IER))) THEN
       NSTYP=1
       GOTO 902
      ENDIF
      IF((MCOMP(ICOM,'H',1,IER)).or.
     +   (MCOMP(ICOM,'HI',2,IER)).or.
     +   (MCOMP(ICOM,'HIS',3,IER)).or.
     +   (MCOMP(ICOM,'HIST',4,IER))) NSTYP=3
      IF(NSTYP.EQ.0) GO TO 900
C
      IF(NSTYP.EQ.1.AND.MACTS.NE.1) GO TO 901
C      IF(NSTYP.EQ.2.AND.MACTS.NE.2) GO TO 902
      IF(NSTYP.EQ.3.AND.MACTS.NE.1) GO TO 903
C
C  GET DATA TYPE(S) AND CHECK
C
      IDD1=MAP(1)
      IFTYP1=IDATYP(IDD1/7+1)
      IFTYP = MOD(IFTYP1,10)
      IF (IFTYP .NE. 1  .AND.  IFTYP .NE. 2  .AND.  IFTYP .NE. 3  .AND.
     +    IFTYP .NE. 7  .AND.  IFTYP .NE. 8 ) GO TO 904
C      IF(NSTYP.EQ.2  .AND.  (IFTYP1.NE.7  .AND.  IFTYP2.NE.7) ) GO TO 905
C
C  NOW CALL APPROPRIATE STATISTICAL ROUTINE
C
      GO TO(50,60,70), NSTYP
C
C  DESCRIBE
C
50    CONTINUE
      IF(IFTYP1.LE.5.OR.IFTYP1.GT.10) CALL SDESCR(LINES,IDD1)
      IF(IFTYP1.eq.7) then
        CALL SDESC(LINES,IDD1)
      else
       if(iftyp1.eq.8) go to 909
      endif
      GO TO 960
C
C  CROSSTABS
C
60    CONTINUE
C      CALL SCROST(LINES,IDD1,IDD2)
      GO TO 960
C
C  HISTOGRAMS
C
70    IF (IFTYP1 .gt.0.and.iftyp1.lt.7)then
         CALL HSTPOL(LINES,IDD1,IFTYP1,ier)
         if(ier.eq.0)then
          read(*,'(a1)')ans
          write(*,*)char(27),char(12)
          GO TO 960
         endif
      endif
C
80    IF ( IFTYP1 .EQ. 8 ) CALL HSTCNT (IDD1,ier)
      IF ( IFTYP1 .EQ. 7 )  CALL HSTDSC ( IDD1,ier )
      if(ier.eq.0)then
       read(*,'(a1)')ans
       write(*,*)char(27),char(12)
       GO TO 960
      endif
C
C  ERROR PROCESSING
C
 900  WRITE(NPRNT,3000)
 3000 FORMAT(' ILLEGAL STATISTICS TYPE')
      GO TO 950
C
 901  WRITE(NPRNT,3001)
 3001 FORMAT(' ONE ACTIVE DATA SET REQUIRED FOR DESCRIBE')
      GO TO 950
C
 902  WRITE(NPRNT,3002)
 3002 FORMAT(' SORRY, STATISTICS CROSSTABS NOT IMPLEMENTED YET')
      GO TO 950
C
 903  WRITE(NPRNT,3003)
 3003 FORMAT(' ONE ACTIVE MAP SET REQUIRED FOR HISTOGRAM')
      GO TO 950
C
 904  WRITE(NPRNT,3004) IFTYP1
 3004 FORMAT(' *STATISTICS* MUST USE POINT,LINE,POLYGON,DISCRETE OR',/,
     +       ' CONTINUOUS MAPS, NOT TYPE',I5)
      GO TO 950
C
 905  WRITE(NPRNT,3005) IFTYP1,IFTYP2
 3005 FORMAT('  MUST USE DISCRETE CELL MAPS IN CROSSTABS NOT TYPE',I5,
     +       ' OR',I5)
      GO TO 950
C
8000  WRITE(NPRNT,98000) IER
98000 FORMAT(' *STATISTICS*  ERROR FROM Qinitl    ERROR',I5)
      GO TO 950
C
909   write(*,*)' DESCRIBE not allowed on type 8 maps.'
 950  LINES=LINES+2
 960  CONTINUE
C
C  JUMP OUT
C
 990  continue
      END
