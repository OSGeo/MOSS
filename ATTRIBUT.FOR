C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C   P R O G R A M    ATTRIBUTE
C
C FUNCTION : THIS PROGRAM IS USED TO CREATE AN ASSOCIATED ATTRIBUTES
C            DATA BASE
C
C PARAMETER : THIS IS THE MAIN PROGRAM
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
$Include:'IO.inc'
$Include:'MAPNAME.inc'
$Include:'STRNG.inc'
$Include:'WORK.inc'
        COMMON/ UNIT / CHANEL, ATRIBTE, POLYGON, ADRESS
        INTEGER CHANEL, ATRIBTE, POLYGON, ACTION, ADRESS, RECORD( 128 )
        LOGICAL FOUND,mcomp
C
C
C  INITIALIZE
C
          icard(80)=0
          CALL initl(ier)
          if(ier.ne.0 )stop
C
C TEST TO SEE IF < ATTDESCRIBE > HAS BEEN SIGNALED FIRST
C
        IF(ICARD(80).NE.0)THEN
          CALL ATTDSC(IER)
          IF(IER.NE.0)go to 9898
          WRITE(NPRNT,9989)
9989  format(//,' Do you wish to "ADD" the attribute(s) [(Y)/N]'\)
          call readin(iget,1,kk,iend)
          if(mcomp(iget,'N',1,ier))go to 9898
        ENDIF
C
C USER EITHER WANTS TO DO < ATTRIBUTE > OR CONTINUE AFTER <ATTDESCRIBE >
C
        CALL DECIP(ICARD,ICOM,ICARDP)
        IF(ICOM(1).EQ.0) THEN
 5600     WRITE(NPRNT,5678)
 5678     FORMAT(' PLEASE ENTER NAME OF  MAP (CR=QUIT)'\)
          CALL READIN(ICARD,LENICD,ICARDP,istop)
          IF(ICARD(1) .EQ. 0) GOTO 9898
          do 11l=1,istop
          if(icard(l).eq.46)then
          write(*,*)' a map name can must not contain a period-',
     +    'rename it and try again'
          go to 5600
          endif
   11    continue
          CALL DECIP(ICARD,ICOM,ICARDP)
        ENDIF
C
C  EVERYTHING O.K. TO THIS POINT.  LETS PACK THE MAP NAME
C  AND OPEN A DATA CHANNEL TO THE MAP OF INTEREST
C
        ICHAN1=10
        CHANEL=ICHAN1+20
        CALL GTNAM(-1,0,ICOM,MAP,IER)
        CALL OPENF(ICHAN1,MAP,1,256,2,IER)
        IF(IER.NE.0) GO TO 900
C
C SAVE MAP NAME FOR MERGATT & IN CASE USER WISHES TO PERFORM DELETE
C
        DO 1122 I=1,10
          NAME(I)=MAP(I)
 1122   CONTINUE
C
C  CHANNEL OPEN.  NOW LETS READ IN HEADER BLOCK
C
        CALL RDBLK(ICHAN1,1,IBUFF,1,IER)
C
C  GET NUMBER OF FEATURES
C
       NENTS=IBUFF(63)
C
C  GENERATE EXTENSION NAME
C
        CALL GTNAM(-1,4,ICOM,MAP,IER)
C
C  DOES THIS MAP HAVE AN ATTRIBUTE FILE ?
C
23    IF(IBUFF(76).EQ.0) THEN
C
C  NO, IT DOES NOT.  LETS CREATE ONE!
C
  2     CONTINUE
        WRITE(NPRNT,5999) (ICARD(l),l=1,8)
5999    FORMAT(1x,'*** Attribute file for map ',8A1,
     +  ' DOES NOT EXIST ***',/' DO YOU WISH TO CREATE IT', 
     +  ' ((Y)/N=QUIT)'\)
        CALL READIN(ICARD,LENICD,ICARDP,istop)
        IF(ICARD(1).EQ.78.OR.ICARD(1).EQ.110) GOTO 9898
        Call OPENF(chanel,map,0,256,2,ier)
        if(ier.eq.0)go to 6793
        WRITE(NPRNT,1002) IER
 1002   FORMAT(' COULD NOT CREATE THE ATTRIBUTE FILE.   ERROR',I5)
        STOP
 6793   CONTINUE
C
C  NEW ATTRIBUTE FILE HAS BEEN CREATED.  NOW SET WORD 76 IN POLYGON
C  HEADER RECORD TO 1 AND WRITE THE BLOCK BACK OUT
C
        IBUFF(76)=1
        CALL WRBLK(ICHAN1,1,IBUFF,1,IER)
        IF(IER.NE.0) GOTO 940
C
C  SINCE THIS IS THE FIRST TIME FOR THIS DATA BASE, WRITE OUT
C  FIRST RECORD...AND RECORD 202 HERE INSTEAD OF IN INITIAL...RF
C
             DO 800 I=1,128
               RECORD(I) = 0
800          CONTINUE
C
             RECORD(1)=0
             RECORD(2)=NENTS
             CALL WRBLK(chanel,1,RECORD,1,IER)
             IF (IER .NE. 0) GO TO 960
C
             CALL WRBLK(chanel,202,RECORD,1,IER)
             IF (IER .NE. 0) GO TO 960
C
C  OR DO NORMAL OPEN AND INITIALIZATION
C
      ELSE
C+
        call openf(chanel,map,1,256,2,ier)
        if(ier.ne.0)then
         ibuff(76)=0
         go to 23
        endif
C
        ENDIF
C
C SUBROUTINE INTIAL RETURNS THE VALUES OF THE NUMBER OF ATRIBUTES IN THE
C FILE, AND THE NUMBER OF POLYGoNS IN AN ATTRIBUTE SET. ( VARIBLES ATRBTE
C AND POLYGON RESPECTIVELY )
C
          CALL INITIAL
C
C  PICK OPTION
C
1         CONTINUE
CC
            WRITE(NPRNT,1100) ATRIBTE,POLYGON
 1100       FORMAT(/' THE NUMBER OF ATTRIBUTES IS ',I5,
     1             /' THE NUMBER OF FEATURES IS   ',I5/)
C
            WRITE(NPRNT,1101)
 1101       FORMAT(' PLEASE ENTER DESIRED OPTION ',
     1           //'     SEARCH AN ATTRIBUTE FIELD   = 1',
     2            /'     ADD A NEW ATTRIBUTE         = 2',
     3            /'     UPDATE AN EXISTING ATTRIBUTE= 3',
     4            /'     LIST AN ATTRIBUTE FIELD     = 4',
     5            /'     DELETE THE ATTRIBUTE FILE   = 5',
     6            /'     EXIT THE ATTRIBUTE PROGRAM  = 6  :'\)
CC
       CALL READIN(ICARD,LENICD,ICARDP,istop)
       if(icard(1).eq.0)go to 9000
       CALL INUM(ICARD,ACTION,ICARDP)
CC
            GO TO ( 1500, 2000, 3500, 4000, 5000, 9000 ) ACTION
CC
            WRITE(NPRNT,1051)
 1051       FORMAT(' INVALID OPTION.  TRY AGAIN.')
            GO TO 1
CC
CC SEARCH FOR A PATICULAR ATTRIBUTE AND LIST OUT THE POLYGON SET OF THE
CC ATTRIBUTE OF INTEREST IF FOUND
CC
1500        CONTINUE
              CALL RETRVL( FOUND, RECORD )
               IF( .NOT. FOUND )GO TO 1
                CALL HEADER( RECORD )
                IF( RECORD( 84 ) .EQ. 1 )CALL DIGOUT( RECORD( 86 ) )
                IF( RECORD( 84 ) .EQ. 2 ) CALL RLSOUT( RECORD( 86 ) )
                IF( RECORD( 84 ) .EQ. 3 )
     -                  CALL CHROUT( RECORD( 86 ), RECORD( 85 ) )
            GO TO 1
CC
CC CREATE AN ASSOCIATED ATTRIBUTE DATA BASE OR ADD MORE ATTRIBUTES TO AN
CC ALREADY EXISTING DATA BASE
CC
2000        CONTINUE
              CALL PUTAT
            GO TO 1
CC
CC ZERO OUT THE VALUES OF THE POLYGON SET OF A SPECIFIED ATTRIBUTE AND
CC INSERT NEW POLYGON ATTRIBUTE VALUES.
CC
3500        CONTINUE
              CALL UPDATE
            GO TO 1
CC
CC
CC LIST OUT THE ATTRIBUTES SETS AND THEIR POLYGON VALUES.
CC
4000        CONTINUE
              CALL LISTAT
            GO TO 1
C
C  DELETE ATTRIBIUTE FILE
C
 5000  CONTINUE
C
C ZERO ATTRIBUTE FILE <Y/N> FLAG
C
      write(nprnt,5001)
5001  format (//' Are you sure? Answering ''Y'' will ERASE the',/
     1 ' multiple attribute file.  [Y/(N)]')
      call readin (iget,1,kk,iend)
      if (.not.(mcomp(iget,'Y',1,ier))) goto 1
      CALL RDBLK(ICHAN1,1,IBUFF,1,IER)
      IBUFF(76)=0
      CALL WRBLK(ICHAN1,1,IBUFF,1,IER)
      IF (IER .NE. 0) GO TO 940
      CLOSE(ICHAN1,iostat=IER)
C
       CLOSE(CHANEL,status='DELETE',iostat=IER)
       IF(IER.NE.0) GO TO 920
C
       WRITE(NPRNT,95000)
95000  FORMAT(' OK,  ATTRIBUTE FILE DELETED.')
       GO TO 9000
C
C  SORT INPUT FILE TO MATCH NEW I.D.'S IN MAP UPDATE
C
 6000  CONTINUE
       ICHAN2=2
        WRITE (*,*) ' STILL UNDER CONSTRUCTION - OPENING SOON'
C       CALL MERGATT(ICHAN2,IER)
C       IF (IER .NE. 0) STOP
       GO TO 1
CC
CC THE ASSOCIATED ATTRIBUTES DATA BASE FILE DID NOT OPEN CORRECTLY.
CC
3050   CONTINUE
       WRITE(NPRNT,1050) IER
 1050  FORMAT(' THE ATTRIBUTE FILE DID NOT OPEN CORRECTLY  ERROR',I5,
     1       /' CREATING NEW .AT FILE ON DISK')
      GO TO 2
CC
CC THE PROGRAM TERMINATED IN A NORMAL MANNER.
CC
9000        CONTINUE
              CLOSE(CHANEL,iostat=IER)
              CLOSE(ichan1,iostat=IER)
              GOTO 9898
C             
C  ERROR RETURNS
C
  900  CONTINUE
       WRITE(NPRNT,90900) (MAP(I),I=1,10), IER
90900  FORMAT(' ERROR OPENING FILE ',10A2,'  ERROR',I5)
       STOP
  910  CONTINUE
       WRITE(NPRNT,90910) (NAME(I),I=1,10), IER
90910  FORMAT(' ERROR OPENING FILE ',10A2,'  ERROR',I5)
       STOP
 920   WRITE(NPRNT,3020) IER
 3020  FORMAT(' COULD NOT DELETE ATTRIBUTE FILE  ERROR',I5)
       STOP
 940   WRITE(NPRNT, 3040) IER
 3040  FORMAT(' ERROR WRITING TO MAP - -  ERROR',I5)
       stop
C
 960  WRITE(NPRNT,3060) IER
3060  FORMAT(' ERROR WRITING TO ATTRIBUTE FILE  - ERROR',I5)
9898  continue
       END
