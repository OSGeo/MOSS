C***********************************************************************
C
C          P R O G R A M   B S E A R C H
C
C  FUNCTION - BSEARCH DOES A BOOLEAN SEARCH OF AN ATTRIBUTE FILE
C             AND SELECTS OUT THOSE ITEMS WITH ATTRIBUTES THAT MATCH
C             THE BOOLEAN SEARCH STRING
C
      COMMON /FLS/    IUNIT,IFILE(5)
      COMMON /IO/     NPRNT,IOIN
      COMMON /PNTFET/ NPOINT
      COMMON /STRNG/  ICARD(80),icardp,lenicd
      COMMON /ATTFET/ KBAT(86),LBAT
      COMMON /WHMAP/  ISTRCT(300),NSTRCT
      COMMON /TYPE/   IDATYP(40),NACTS
      COMMON /WORK/   IBUFF(128),MAP(25),ICOM(10),JCOM(10)
      COMMON /UNIT/   CHANEL,ATRBTE,POLYGON,ADRESS
C
      INTEGER IMAP(20,2),ISTAK(128),IREL(20,37),ITVAL(2)
      INTEGER ISTRNG(80),ISEL(15),ONE,TWO,IICOM(72),IIMAP(36)
      INTEGER CHANEL,ATRBTE,POLYGON,ADRESS
      INTEGER WORD,BIT,mapname(25)
      LOGICAL FOUND,MCOMP
      EQUIVALENCE (VAL,ITVAL)
      DATA MAXSTK/128/
C
C.....READ IN COMMON AND OPEN GRAPHICS DEVICE
      CALL initl(ier)
      if(ier.ne.0)stop
C      CALL OPEN(IUNIT,IFILE,2,IER)
C
C.....INITIALIZE SOME ARRAYS
C
      LINES = 1
      DO 2 I = 1,20
         IMAP(I,1) = 0
         IMAP(I,2) = 0
         DO 1 J = 1,37
            IREL(I,J) = 0
 1       CONTINUE
 2    CONTINUE
C
      DO 3 I = 1,128
         ISTAK(I) = 0
 3    CONTINUE
C
C.....SAVE CURRENT POINT.DT POINTER LOCATION
C
      NPSAVE=NPOINT+1
C
C.....CHECK IF USER HAS ALREADY ENTERED MAP NAME
C
      CALL DECIP(ICARD,JCOM,icardp)
      IF(JCOM(1).NE.0) GO TO 10
C
C.....USER MUST ENTER MAP NAME.
C
      WRITE(NPRNT,1000)
 1000 FORMAT(' PLEASE ENTER NAME OF MAP TO SEARCH'\)
      CALL READIN(ICARD,lenicd,icardp,istop)
      CALL DECIP(ICARD,JCOM,icardp)
      LINES=LINES+2
C
C.....SAVE POINTER FOR CONTINUED COMMAND AND CHECK FOR VALID MAP NAME
C
  10  CONTINUE
      KKK = icardp
      IF(JCOM(1).EQ.0) GO TO 900
      CALL MCHEK(JCOM,IFIL,NENTS,ITYPE,IER)
      IF(IFIL.EQ.0) GO TO 910
C flag if in master dir
      if(ifil.eq.1)jcom(1)=(-jcom(1))
C
      IF(NENTS.LT.0) GO TO 920
      IF ((ITYPE .LT. 1) .OR. (ITYPE .GT. 3)) GO TO 930
C
C.....CREATE PATHNAME TO MAP FILE AND OPEN
C
      MCHAN=10
      CALL GTNAM(-1,0,JCOM,MAP,IER)
c if in master set it up for pathname inclusion
      call adddir(map,mapname)
      CALL OPENF(MCHAN,MAPname,1,256,2,IER)
      IF(IER.NE.0) GO TO 940
C
C.....READ MAP HEADER AND CHECK FOR ATTRIBUTE FILE EXISTENCE
C
      CALL RDBLK(MCHAN,1,IBUFF,1,IER)
      KKTYPE = IBUFF(62)
      NENTS = IBUFF(63)
C
C.....IF NO ATTRIBUTES, NO BSEARCH.
      IF (IBUFF(76) .NE. 1) GO TO 950
C
C.....AND RESTRAIN USER FROM MORE THAN 8192 ITEM IN MAP.  "LIMITATION"
       IF (NENTS .GT. 8192) GO TO 970
C
C.....CREATE PATHNAME TO .AT FILE AND OPEN
C
      MENDEX=IBUFF(64)+IBUFF(65)+2
      CHANEL=mchan+20
      CALL GTNAM(-1,4,JCOM,MAP,IER)
C if in master add pathname
      call adddir(map,mapname)
      CALL OPENF(CHANEL,MAPname,1,256,2,IER)
      IF (IER .NE. 0) GO TO 940
C
C.....READ .AT FILE HEADER
      CALL INITIAL
C
C.....SET SOME PARAMETERS
      IM   = 0
      IS   = 0
      NPAR = 0
C
C.....PROMPT FOR SEARCH STRING
C
      WRITE(NPRNT,1004)
 1004 FORMAT(' ENTER LOGICAL EXPRESSION'\)
      CALL READIN(ISTRNG,lenicd,icardp,istop)
      NEXT = 1
C
C.....JUMP TO CORRECT PLACE IN CODE ON "NEXT"  (MAIN LOOP = 100)
C
 100  CONTINUE
      GO TO(110,120,130,140,150,160,200),NEXT
C
C.....MAP NAME OR PAREN
C
 110  CONTINUE
      FOUND=.FALSE.
      CALL DECIP(ISTRNG,ICOM,icardp)
 104  CONTINUE
      IF(MCOMP(ICOM,'&',1,IER)) CALL READIN(ISTRNG,lenicd,icardp,istop)
      IF(MCOMP(ICOM,'&',1,IER)) GO TO 110
      IF(MCOMP(ICOM,'*',1,IER)  .OR.  ICOM(1) .EQ. 0) GO TO 200
      IF(MCOMP(ICOM,'(',1,IER)) GO TO 120
      IF(MCOMP(ICOM,')',1,IER)) GO TO 130
      LENGTH=ATRBTE+1
C
C.....LOOP THROUGH THE ATTRIBUTE KEYS AND CHECK FOR A MATCH
      DO 102 LOCATE=2,LENGTH
         CALL RDBLK(CHANEL,LOCATE,IBUFF,1,IER)
         INDEX=1
         DO 101 J=2,11
            IF(ICOM(INDEX).NE.IBUFF(J)) GO TO 102
            INDEX=INDEX+1
 101     CONTINUE
         FOUND=.TRUE.
         GO TO 103
 102  CONTINUE
C
 103  IF (.NOT. FOUND) GO TO 50
C
C.....SAVE THE SEARCH STRING FOR ADSTAD AND ACTIVE TABLE
      CALL PACKC(ISTRNG,ISEL,30)
C
      NEXT=5
      IM=IM+1
      IS=IS+1
      ISTAK(IS)=IM
      IMAP(IM,1)=IBUFF(86)
      IMAP(IM,2)=IBUFF(84)
      IF(IBUFF(84).EQ.3) IMAP(IM,2) = -IBUFF(85)
      GO TO 100
C
  50  CONTINUE
      WRITE(NPRNT,1002)
 1002 FORMAT(' BAD KEY.  DO YOU WISH TO RE-ENTER? (Y/N)  [Y]  '\)
      CALL READIN(ISTRNG,lenicd,icardp,istop)
      IF(MCOMP(ISTRNG,'N',1,IER)) GO TO 9999
C
C.....RE-ENTER SEARCH STRING
      WRITE(NPRNT,1004)
      CALL READIN(ISTRNG,lenicd,icardp,istop)
      CALL DECIP(ISTRNG,ICOM,icardp)
      FOUND = .FALSE.
      GO TO 104
C
C.....LEFT PAREN
C
 120  CONTINUE
      IPRI=4
      NEXT=1
      IS=IS+1
C
C.....IF THERE WAS A SPACE AFTER THE PAREN, ACCOUNT FOR IT.
C
      IF (ISTRNG(icardp+1) .EQ. 32) icardp = icardp + 1
      IF(IS.GT.MAXSTK) GO TO 990
      ISTAK(IS)=-1
      NPAR=NPAR+1
      GO TO 100
C
C.....RIGHT PAREN
C
 130  CONTINUE
      NEXT=4
      IS=IS+1
      ISTAK(IS)=-2
      NPAR=NPAR-1
      icardp = icardp + 1
      GO TO 100
C
C.....OPERATOR
C
 140  CONTINUE
      NEXT=1
      CALL DECIP(ISTRNG,ICOM,icardp)
      IF(MCOMP(ICOM,'&',1,IER)) CALL READIN(ISTRNG,lenicd,icardp,istop)
      IF(MCOMP(ICOM,'&',1,IER)) GO TO 140
      IF(MCOMP(ICOM,'*',1,IER)  .OR.  ICOM(1) .EQ. 0) GO TO 200
      IF(MCOMP(ICOM,')',1,IER)) GO TO 130
      IF(MCOMP(ICOM,'(',1,IER)) GO TO 120
      IOPER=0
C
      IF(MCOMP(ICOM,'AND',3,IER)) IOPER=-4
      IF(MCOMP(ICOM,'OR',2,IER)) IOPER=-3
      IF(IOPER.EQ.0) GO TO 995
      IS=IS+1
      IF(IS.GT.MAXSTK) GO TO 990
      ISTAK(IS)=IOPER
      GO TO 100
C
C.....RELATION
C
 150  CONTINUE
      NEXT=6
      CALL DECIP(ISTRNG,ICOM,icardp)
      KREL=0
      IF(MCOMP(ICOM,'LE',2,IER)) KREL=1
      IF(MCOMP(ICOM,'LT',2,IER)) KREL=2
      IF(MCOMP(ICOM,'EQ',2,IER)) KREL=3
      IF(MCOMP(ICOM,'NE',2,IER)) KREL=4
      IF(MCOMP(ICOM,'GT',2,IER)) KREL=5
      IF(MCOMP(ICOM,'GE',2,IER)) KREL=6
      IF(MCOMP(ICOM,'$$',2,IER)) KREL=7
C
      IF(KREL.EQ.0) GO TO 980
      IREL(IM,1)=KREL
      GO TO 100
C
C.....GET THE VALUES FROM THE COMMAND LINE
C
 160  CONTINUE
      NEXT=4
      ITYPE=IMAP(IM,2)
      IF(ITYPE.LT.0) ITYPE=3
      GO TO(162,164,166),ITYPE
C
C.....INTEGER
 162  CALL INUM(ISTRNG,IVAL,icardp)
      IREL(IM,2)=IVAL
      GO TO 100
C
C.....REAL
 164  CALL FNUM(ISTRNG,80,VAL,icardp)
      IREL(IM,2)=ITVAL(1)
      IREL(IM,3)=ITVAL(2)
      GO TO 100
C
C.....CHARACTER
 166  CONTINUE
      MAXCOM=72
      CALL DECIP1(ISTRNG,IICOM,icardp,NUMCHR,MAXCOM,IER)
      IF (IER .NE. 0) GO TO 997
      do 4 l=1,36
   4  iimap(l)=32
      CALL PACKC(IICOM,IIMAP,72)
      DO 167 I = 1,36
         IREL(IM,I+1) = IIMAP(I)
 167  CONTINUE
      GO TO 100
C
C  WE HAVE FINISHED SEARCH. TIME TO UPDATE POINT.DT
C
  200 CONTINUE
      IF (IS .EQ. 0) GO TO 9999
C
C  CHECK FOR PAREN CLOSEURE
C
       IF(NPAR.NE.0) GO TO 996
C
C  CALL REVERSE POLISH ROUTINE
C
       CALL RPN(ISTAK,IBUFF,IS,NSYMB,IER)
C
C  IF WE GOT SOMETHING, LETS EVALUATE THE ATTRIBUTE DATA
C
      IF(NSYMB.GT.0) CALL MAEVAL(ISTAK,NSYMB,IMAP,IREL,IM,mchan,
     1  NHITS,IER)
      IF (IER .NE. 0) GO TO 9999
C      IF (IER .EQ. -80) NPOINT = NPSAVE - 1
C      IF (IER .EQ. -80) GO TO 9999
      
C
C  NO HITS
C
      LINES = LINES + 2
      IF(NHITS .LE. 0) WRITE(NPRNT,2008)
 2008 FORMAT(' NO FEATURES MEET SEARCH STRING CRITERIA')
      IF(NHITS.LE.0) GO TO 9999
C
C  SOME HITS, UPDATE RUN TIME STRUCTURE
C
      LBAT=(NSTRCT/7)*2+1
      KBAT(LBAT)=4
      LBAT=LBAT+1
      KBAT(LBAT)=0
      NACTS=NACTS+1
      IDATYP(NACTS)=KKTYPE
      CALL PACKC(JCOM,MAP,10)
      CALL ADSTAD(IER,MAP,NHITS,NPSAVE,ISEL,4)
      WRITE(NPRNT,1050) NHITS,NACTS
1050  FORMAT(1X,I5,' ITEMS FOR ACTIVE ID',I5)
      GO TO 9999
C
C  ERROR RETURNS
C
 900  WRITE(NPRNT,3000)
 3000 FORMAT(' YOU FORGOT TO SPECIFY A MAP NAME!')
      LINES=LINES+2
      GO TO 9999
 910  WRITE(NPRNT,3010)
 3010 FORMAT(' THIS MAP DOES NOT EXIST.')
      LINES=LINES+2
      GO TO 9999
 920  WRITE(NPRNT,3020)
 3020 FORMAT(' THIS MAP HAS BEEN ARCHIVED.')
      LINES=LINES+2
      GO TO 9999
 930  WRITE(NPRNT,3030)
 3030 FORMAT(' CANNOT DO ATTRIBUTE SEARCHES ON CELL FILES.')
      LINES=LINES+2
      GO TO 9999
 940  WRITE(NPRNT,3040) (MAPname(I),I=1,25),IER
 3040 FORMAT(' COULD NOT OPEN MAP FILE',25A1,'  ERROR',I5)
      LINES=LINES+2
      GO TO 9999
 950  WRITE(NPRNT,3050)
 3050 FORMAT(' THIS MAP DOES NOT HAVE AN ATTRIBUTE FILE')
      LINES=LINES+2
      GO TO 9999
 970  WRITE(NPRNT,3070)
 3070 FORMAT(' *BSEARCH* TOO MANY ITEMS FOR THIS VERSION MAX IS 8192')
      LINES=LINES+2
      GO TO 9999
 980  WRITE(NPRNT,3080)
 3080  FORMAT(' ILLEGAL RELATIONAL. MUST BE LE, LT, NE, EQ, GT, GE')
       LINES=LINES+2
       GO TO 9999
 990  WRITE(NPRNT,3090) MAXSTK
 3090 FORMAT(' *BSEARCH* TOO MANY ITEMS IN SEARCH STRING MAX IS',I5)
      LINES=LINES+2
      GO TO 9999
 995  WRITE(NPRNT,3095)
 3095 FORMAT(' ILLEGAL OPERAND.  MUST BE AND, OR')
      LINES=LINES+2
      GO TO 9999
 996  WRITE(NPRNT,3096)
 3096  FORMAT(' UN-BALANCED PARENTHESIS ')
       LINES=LINES+2
       GO TO 9999
 997  WRITE(NPRNT,3097)
 3097 FORMAT(' UN-MATCHED QUOTES')
      LINES = LINES + 2
      GO TO 9999
C
C  EXIT FROM BSEARCH
C
 9999 CONTINUE
       CLOSE(MCHAN,iostat=IER)
       CLOSE(CHANEL,iostat=IER)
C      CALL CPLAC(LINES)
C      CALL POSTF
C      CALL CLOSE(IUNIT,IER)
      icardp = KKK
      CALL OUTCM
C
      END
